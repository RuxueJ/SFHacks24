<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HomePage</title>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <div class="video-section">
        <button onclick="turnOnCamera()">Turn On Camera</button>
        <button onclick="turnOffCamera()">Turn Off Camera</button>
        <button onclick="capturePicture()">Capture Picture</button>
        <div class="oncamera">
            <video id="videoFeed" autoplay style="display: none;"></video>
        </div>
    </div>

    <div id="popup" class="popup">
        <div class="popup-content">
            <span class="close" onclick="closePopup()">&times;</span>
            <div class="result-section">
                <h1>Results:</h1>
                <div class="img-result">
                    <div id="imagePreview"></div>
                <p id="content"></p>
                <p id="result"></p>
                </div>
            </div>
        </div>
    </div>


    <h1>Results:</h1>
    <p id="result"></p>

    <script>
        let videoStream;
        let videoElement = document.getElementById('videoFeed');
        let canvas = document.createElement('canvas');
        let context = canvas.getContext('2d');

        async function turnOnCamera() {
            try {
                const constraints = {
                    video: {
                        facingMode: { exact: 'environment' } // Specify 'environment' for the back camera
                    }
                };
                videoStream = await navigator.mediaDevices.getUserMedia(constraints);
                videoElement.srcObject = videoStream;
                videoElement.style.display = 'block';
            } catch (error) {
                console.error('Error accessing camera:', error);
                alert('Could not access the camera. Please make sure it is enabled and try again.');
            }
        }


        function turnOffCamera() {
            if (videoStream) {
                const tracks = videoStream.getTracks();
                tracks.forEach(track => track.stop());
                videoStream = null;
                videoElement.style.display = 'none';
            }
        }


        async function capturePicture() {

            if (!videoStream) {
                alert('Please turn on the camera first.');
                return;
            }


            document.getElementById('popup').style.display = 'block';
            context.drawImage(videoElement, 0, 0, canvas.width, canvas.height);
            const imageData = canvas.toDataURL('image/jpeg');
            displayImage(imageData);
          
            const contentParagraph = document.getElementById('content');
            contentParagraph.textContent = 'Captured Image Data: ' + imageData;
        
            const response = await getResponse(imageData);
            let result = document.getElementById("result");
            result.innerHTML = response;
            console.log(response);

            try {
                const response = await getResponse(imageData);
                let result = document.getElementById("result");

                // Format response data as string
                const formattedResult = formatResponse(response);

                // Display formatted result
                result.innerHTML = formattedResult;
            } catch (error) {
                console.error('Error while fetching response:', error);
            }


        }

        function formatResponse(response) {
            // Extract the content value from the response data
            const content = response.choices[0]?.message?.content;

            // Return the content value
            return content || 'No content available';
        }

        async function getResponse(imgUrl) {
       
            try {
                const response = await axios.post('https://api.fireworks.ai/inference/v1/chat/completions', {
                    model: "accounts/fireworks/models/firellava-13b",
                    max_tokens: 512,
                    top_p: 1,
                    top_k: 40,
                    presence_penalty: 0,
                    frequency_penalty: 0,
                    temperature: 0.6,
                    messages: [
                        {
                            role: "user",
                            content: [
                                {
                                    type: "text",
                                    text: "answer in one word what option of this trash object (composed, recycle, landfill, or hazardous-waste)"
                                },
                                {
                                    type: "image_url",
                                    image_url: {
                                        url: imgUrl
                                    }

                                }
                            ]
                        }
                    ]
                }, {
                    headers: {
                        'Accept': "application/json",
                        'Content-Type': "application/json",
                        'Authorization': `Bearer S1m4uyIybO6L8SzvTr0j0OHsKIMGj2vPx63jkGOg3K2jzZlp`
                    }
                });

                return response.data;
            } catch (error) {
                throw error;
            }




        function displayImage(imageData) {
            const imagePreview = document.getElementById('imagePreview');
            const img = new Image();
            img.src = imageData;
            // img.style.maxWidth = '50%';
            // img.style.maxHeight = '50%'; // Limit the height for display
            imagePreview.innerHTML = ''; // Clear previous content
            imagePreview.appendChild(img);
        }



        function closePopup() {
            document.getElementById('popup').style.display = 'none';

        }

    </script>
</body>

</html>